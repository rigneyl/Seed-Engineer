<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Over-Explanation Detector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #0d0d10;
      --bg-elevated: #15151a;
      --bg-soft: #1d1d24;
      --border-subtle: #30303b;
      --accent: #f5c75c;
      --accent-soft: rgba(245, 199, 92, 0.1);
      --text-main: #f5f5f7;
      --text-muted: #a5a5b5;
      --danger: #ff6b81;
      --warning: #ffd36b;
      --info: #7fd0ff;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
    }

    body.theme-light {
      --bg: #f7f7fa;
      --bg-elevated: #ffffff;
      --bg-soft: #f0f0f5;
      --border-subtle: #d4d4e0;
      --accent: #b58900;
      --accent-soft: rgba(181, 137, 0, 0.12);
      --text-main: #111119;
      --text-muted: #5b5b6a;
      --danger: #c0392b;
      --warning: #d9822b;
      --info: #005f99;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #18181f 0, var(--bg) 52%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-shell {
      margin: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: var(--shadow-soft);
      max-width: 1240px;
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 16px 20px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: linear-gradient(120deg, rgba(245, 199, 92, 0.09), transparent);
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title {
      font-size: 18px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title span.badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(245, 199, 92, 0.7);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .app-sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(0, 0, 0, 0.25);
      color: var(--text-muted);
      padding: 4px 9px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
      user-select: none;
    }

    .chip-toggle input {
      display: none;
    }

    .chip-toggle span.knob {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      border: 1px solid var(--border-subtle);
      background: transparent;
    }

    .chip-toggle.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .chip-toggle.active span.knob {
      border-color: transparent;
      background: var(--accent);
    }

    .theme-toggle-btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(0, 0, 0, 0.25);
      color: var(--text-muted);
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .theme-toggle-btn span.icon {
      font-size: 13px;
    }

    .main {
      display: grid;
      grid-template-columns: minmax(0, 2.4fr) minmax(0, 1.6fr);
      gap: 0;
      min-height: 520px;
      max-height: calc(100vh - 110px);
    }

    @media (max-width: 960px) {
      .main {
        grid-template-columns: minmax(0, 1fr);
        max-height: none;
      }
      .analysis-panel {
        border-left: none;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }
    }

    .editor-panel {
      padding: 14px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: radial-gradient(circle at top left, rgba(245, 199, 92, 0.07), transparent 55%);
    }

    .editor-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .pill-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.18);
    }

    .small-text {
      font-size: 11px;
      color: var(--text-muted);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(0, 0, 0, 0.35);
      color: var(--text-main);
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.12s ease, background 0.12s ease;
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    }

    .btn:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
      border-color: rgba(245, 199, 92, 0.7);
      background: radial-gradient(circle at top, rgba(245, 199, 92, 0.18), rgba(0, 0, 0, 0.35));
    }

    .btn-primary {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--accent), #ffefb0);
      color: #26210a;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #ffefb0, var(--accent));
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.85);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
    }

    .btn-icon {
      padding: 4px 9px;
    }

    .btn-icon span {
      font-size: 13px;
    }

    .editor-tabs {
      display: flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      padding: 3px;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .editor-tab {
      flex: 1;
      text-align: center;
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      border: 1px solid transparent;
    }

    .editor-tab.active {
      background: rgba(0, 0, 0, 0.65);
      color: var(--accent);
      border-color: rgba(245, 199, 92, 0.6);
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.4);
    }

    .editor-surfaces {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 320px;
    }

    .editor-surface {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
    }

    .editor-surface.active {
      opacity: 1;
      pointer-events: auto;
    }

    .editor-label-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .editor-label-row .help-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .editor-label-row .help-hint code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.35);
    }

    textarea#draft {
      flex: 1;
      width: 100%;
      resize: none;
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, rgba(245, 199, 92, 0.06), rgba(0, 0, 0, 0.7));
      color: var(--text-main);
      padding: 10px 12px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.55;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.4);
      white-space: pre-wrap;
    }

    textarea#draft::placeholder {
      color: rgba(165, 165, 181, 0.7);
    }

    .ghost-frame {
      flex: 1;
      border-radius: 14px;
      border: 1px dashed var(--border-subtle);
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      padding: 20px;
    }

    .highlight-view {
      flex: 1;
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, rgba(245, 199, 92, 0.05), rgba(0, 0, 0, 0.85));
      padding: 10px 12px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.55;
      overflow: auto;
      white-space: pre-wrap;
    }

    .highlight-view.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 12px;
    }

    .highlight-view.hide-highlights .hl {
      background: none !important;
      box-shadow: none !important;
      border-radius: 0;
      border-bottom: 1px dotted rgba(120, 120, 140, 0.6);
    }

    .hl {
      border-radius: 4px;
      padding: 0 1px;
      margin: 0 -1px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.7);
      cursor: pointer;
    }

    .hl-intro {
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px dotted rgba(180, 180, 200, 0.9);
    }

    .hl-throat {
      background: rgba(255, 107, 129, 0.13);
      border-bottom: 1px dotted var(--danger);
    }

    .hl-doubleback {
      background: rgba(255, 211, 107, 0.16);
      border-bottom: 1px dotted var(--warning);
    }

    .hl-circular {
      background: rgba(127, 208, 255, 0.14);
      border-bottom: 1px dotted var(--info);
    }

    .hl-thesis {
      background: rgba(245, 199, 92, 0.19);
      border-bottom: 1px dotted var(--accent);
    }

    .hl-meta {
      background: rgba(181, 137, 0, 0.16);
      border-bottom: 1px dotted rgba(181, 137, 0, 1);
    }

    .hl-pulse {
      animation: pulse 1s ease-out;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(245, 199, 92, 0.8); }
      100% { box-shadow: 0 0 0 10px rgba(245, 199, 92, 0); }
    }

    .editor-footer {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #33d17a;
      box-shadow: 0 0 0 4px rgba(51, 209, 122, 0.22);
      margin-right: 5px;
    }

    .analysis-panel {
      padding: 14px 14px 16px;
      border-left: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: radial-gradient(circle at top right, rgba(127, 208, 255, 0.06), transparent 55%);
    }

    .analysis-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .analysis-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .analysis-title span.dot {
      display: inline-block;
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: var(--accent);
      margin-right: 6px;
    }

    .analysis-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 2px 7px;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.35);
    }

    .pill strong {
      color: var(--accent);
      font-weight: 600;
    }

    .analysis-sections {
      flex: 1;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section-card {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.6));
      padding: 9px 10px 9px;
      font-size: 12px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
    }

    .section-title span.marker {
      width: 12px;
      height: 2px;
      border-radius: 999px;
      background: var(--border-subtle);
    }

    .section-title span.marker.intro { background: rgba(180, 180, 200, 0.9); }
    .section-title span.marker.throat { background: var(--danger); }
    .section-title span.marker.doubleback { background: var(--warning); }
    .section-title span.marker.circular { background: var(--info); }
    .section-title span.marker.thesis { background: var(--accent); }
    .section-title span.marker.meta { background: rgba(181, 137, 0, 1); }

    .section-count {
      font-size: 11px;
      color: var(--text-muted);
    }

    .section-count strong {
      color: var(--accent);
    }

    .section-body {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .section-note {
      font-size: 11px;
      color: var(--text-muted);
    }

    .hit-list {
      list-style: none;
      padding: 0;
      margin: 2px 0 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-height: 120px;
      overflow-y: auto;
    }

    .hit-item {
      padding: 4px 5px;
      border-radius: 8px;
      border: 1px solid transparent;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: transparent;
    }

    .hit-item:hover {
      border-color: rgba(245, 199, 92, 0.5);
      background: rgba(245, 199, 92, 0.09);
    }

    .hit-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .hit-snippet {
      font-size: 11px;
      color: var(--text-main);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .hit-snippet code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
    }

    .footer-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .thesis-terms {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .thesis-term {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.4);
    }

    .preset-panel {
      border-radius: 10px;
      border: 1px dashed var(--border-subtle);
      padding: 7px 8px;
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.35);
    }

    .preset-panel strong {
      color: var(--accent);
    }

    .preset-tags {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .preset-tag {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.55);
    }

    .preset-tag span {
      color: var(--text-main);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="theme-dark">
  <div class="app-shell">
    <header>
      <div class="title-block">
        <div class="app-title">
          OVER-EXPLANATION DETECTOR
          <span class="badge">Local · HTML-first</span>
        </div>
        <div class="app-sub">
          A debug view for long-winded essays, philosophy drafts, and over-talking arguments.
        </div>
      </div>
      <div class="header-actions">
        <button id="themeToggle" class="theme-toggle-btn" type="button">
          <span class="icon" aria-hidden="true">☾</span>
          <span class="label">Ink After Midnight</span>
        </button>
        <label id="writingModeToggle" class="chip-toggle active">
          <span class="knob"></span>
          <span>Writing + Analysis</span>
        </label>
      </div>
    </header>
    <div class="main">
      <section class="editor-panel">
        <div class="editor-toolbar">
          <div class="toolbar-left">
            <div class="pill-label">Draft</div>
            <span class="small-text">Paste your essay or start typing. Then Run Analysis.</span>
          </div>
          <div class="toolbar-right">
            <div class="editor-tabs" aria-label="Editor view mode">
              <div class="editor-tab active" data-tab="editor">Editor</div>
              <div class="editor-tab" data-tab="highlighted">Debug View</div>
            </div>
            <button id="runAnalysisBtn" class="btn btn-primary" type="button">
              <span>◉</span>
              <span>Run Analysis</span>
            </button>
            <button id="exportMdBtn" class="btn btn-ghost" type="button">
              <span>⤓</span>
              <span>.md</span>
            </button>
            <button id="exportHtmlBtn" class="btn btn-ghost" type="button">
              <span>⤓</span>
              <span>Annotated</span>
            </button>
          </div>
        </div>
        <div class="editor-surfaces">
          <div class="editor-surface active" data-surface="editor">
            <div class="editor-label-row">
              <div class="small-text">
                Autosaves locally · No login, no tracking.
              </div>
              <div class="help-hint">
                Tip: Run analysis, fix, run again. <code>CTRL+S</code> to save file from browser.
              </div>
            </div>
            <textarea id="draft" spellcheck="false" placeholder="Example starter:

In today's society, it is important to note that many people misunderstand the nature of despair. What I mean is that despair is not just sadness; rather, it is a deeper and more pervasive sense of futility. In other words, it is the quiet conviction that nothing will fundamentally change.

This paragraph will explore why that conviction keeps looping back on itself, and why, in conclusion, we might say that despair is the only honest response to a dishonest world."></textarea>
          </div>
          <div class="editor-surface" data-surface="highlighted">
            <div class="editor-label-row">
              <div class="small-text">
                <span style="opacity:.8;">Debug view:</span> highlights intros, throat-clearing, circularity, and thesis restatements.
              </div>
              <div class="help-hint">
                <label class="chip-toggle" id="toggleHighlights">
                  <span class="knob"></span>
                  <span>Raw underlines only</span>
                </label>
              </div>
            </div>
            <div id="highlightView" class="highlight-view empty">
              Run analysis to see an annotated view of your draft.
            </div>
          </div>
        </div>
        <div class="editor-footer">
          <div class="small-text">
            <span class="status-dot"></span>
            Offline · All analysis runs in this file.
          </div>
          <div class="small-text" id="statsLine">
            0 words · 0 sentences · 0 paragraphs
          </div>
        </div>
      </section>
      <aside class="analysis-panel" id="analysisPanel">
        <div class="analysis-header">
          <div class="analysis-title">
            <span class="dot"></span>
            Over-Talk Report
          </div>
          <div class="analysis-badges">
            <div class="pill"><strong>Objectivity tools</strong> · no AI</div>
            <div class="pill">Click snippets to jump to highlights</div>
          </div>
        </div>
        <div class="analysis-sections">
          <div class="section-card" data-section="intro">
            <div class="section-header">
              <div class="section-title">
                <span class="marker intro"></span>
                Intro Clauses
              </div>
              <div class="section-count">
                <span>Hits:</span> <strong id="count-intro">0</strong>
              </div>
            </div>
            <div class="section-body">
              <div class="section-note">
                Detects prefatory phrases like “In today’s society…” that often add no information.
              </div>
              <ul class="hit-list" id="list-intro"></ul>
            </div>
          </div>

          <div class="section-card" data-section="throat">
            <div class="section-header">
              <div class="section-title">
                <span class="marker throat"></span>
                Throat Clearing
              </div>
              <div class="section-count">
                <span>Hits:</span> <strong id="count-throat">0</strong>
              </div>
            </div>
            <div class="section-body">
              <div class="section-note">
                Flags “I believe that…”, “I want to say…”, and other verbal warm-up phrases.
              </div>
              <ul class="hit-list" id="list-throat"></ul>
            </div>
          </div>

          <div class="section-card" data-section="doubleback">
            <div class="section-header">
              <div class="section-title">
                <span class="marker doubleback"></span>
                Doubling Back
              </div>
              <div class="section-count">
                <span>Hits:</span> <strong id="count-doubleback">0</strong>
              </div>
            </div>
            <div class="section-body">
              <div class="section-note">
                Finds “What I mean is…”, “In other words…” and similar rephrasing markers.
              </div>
              <ul class="hit-list" id="list-doubleback"></ul>
            </div>
          </div>

          <div class="section-card" data-section="circular">
            <div class="section-header">
              <div class="section-title">
                <span class="marker circular"></span>
                Circular Explanations
              </div>
              <div class="section-count">
                <span>Hits:</span> <strong id="count-circular">0</strong>
              </div>
            </div>
            <div class="section-body">
              <div class="section-note">
                Heuristically detects sentences that repeat the previous one with minor variation.
              </div>
              <ul class="hit-list" id="list-circular"></ul>
            </div>
          </div>

          <div class="section-card" data-section="thesis">
            <div class="section-header">
              <div class="section-title">
                <span class="marker thesis"></span>
                Thesis Restatements
              </div>
              <div class="section-count">
                <span>Hits:</span> <strong id="count-thesis">0</strong>
              </div>
            </div>
            <div class="section-body">
              <div class="section-note">
                Groups repeated key terms; flags later sentences that keep re-stating the core idea.
              </div>
              <ul class="hit-list" id="list-thesis"></ul>
            </div>
          </div>

          <div class="section-card" data-section="meta">
            <div class="section-header">
              <div class="section-title">
                <span class="marker meta"></span>
                Meta-Writing
              </div>
              <div class="section-count">
                <span>Hits:</span> <strong id="count-meta">0</strong>
              </div>
            </div>
            <div class="section-body">
              <div class="section-note">
                Finds “This paragraph will…”, “In the following section…” structural commentary.
              </div>
              <ul class="hit-list" id="list-meta"></ul>
            </div>
          </div>
        </div>
        <div class="footer-meta">
          <div>
            <strong>Thesis terms (top content words)</strong>
            <div id="thesisTerms" class="thesis-terms"></div>
          </div>
          <div class="preset-panel">
            <div><strong>Misanthropic presets</strong> · phrases this tool loves to bully:</div>
            <div class="preset-tags">
              <div class="preset-tag"><span>“In today’s society…”</span></div>
              <div class="preset-tag"><span>“Humanity has always…”</span></div>
              <div class="preset-tag"><span>“Since the dawn of time…”</span></div>
              <div class="preset-tag"><span>“The purpose of this paragraph is…”</span></div>
              <div class="preset-tag"><span>“In other words…”</span></div>
              <div class="preset-tag"><span>“What I really mean is…”</span></div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    (function () {
      const draftEl = document.getElementById('draft');
      const runAnalysisBtn = document.getElementById('runAnalysisBtn');
      const exportMdBtn = document.getElementById('exportMdBtn');
      const exportHtmlBtn = document.getElementById('exportHtmlBtn');
      const statsLine = document.getElementById('statsLine');
      const highlightView = document.getElementById('highlightView');
      const analysisPanel = document.getElementById('analysisPanel');
      const writingModeToggle = document.getElementById('writingModeToggle');
      const themeToggle = document.getElementById('themeToggle');
      const toggleHighlights = document.getElementById('toggleHighlights');
      const body = document.body;

      const editorTabs = document.querySelectorAll('.editor-tab');
      const editorSurfaces = document.querySelectorAll('.editor-surface');

      const patternConfig = {
        intro: {
          phrases: [
            "in today's society",
            "in today’s society",
            "in today's world",
            "in today’s world",
            "in the modern world",
            "in modern society",
            "throughout history",
            "since the dawn of time",
            "since ancient times",
            "as you can see",
            "in conclusion",
            "in summary",
            "it is important to note that",
            "it is important to note",
            "it is important to understand",
            "it should be noted that"
          ],
          label: "Intro clause"
        },
        throat: {
          phrases: [
            "i believe that",
            "i think that",
            "i would argue that",
            "i want to argue that",
            "it seems to me that",
            "i want to say that",
            "this suggests that",
            "one could say that",
            "it could be said that",
            "the point i want to make is",
            "what i want to say is"
          ],
          label: "Throat clearing"
        },
        doubleback: {
          phrases: [
            "what i mean is",
            "what i really mean is",
            "to put it another way",
            "in other words",
            "to put it differently",
            "let me rephrase that",
            "that is to say",
            "to be more precise"
          ],
          label: "Doubling back"
        },
        meta: {
          phrases: [
            "this paragraph will",
            "this section will",
            "in the following section",
            "in the next section",
            "in the following pages",
            "later in this essay",
            "the purpose of this paragraph is",
            "the purpose of this section is",
            "the purpose of this essay is",
            "in this essay i will",
            "in this paper i will"
          ],
          label: "Meta-writing"
        }
      };

      let currentMatches = [];

      const stopwords = new Set([
        "the","and","for","that","with","this","have","from","they","their","there","been","into","would","could","should",
        "about","because","which","when","where","what","were","them","these","those","over","under","such","than","then",
        "also","though","through","only","even","very","just","like","some","most","more","much","many","every","each",
        "other","being","within","without","your","yours","our","ours","any","all","can","cannot","cant",
        "it's","its","it's","its","isn't","wasn't","weren't","aren't","dont","don't","doesnt","doesn't",
        "had","has","have","do","does","did","am","is","are","was","were","be","been","being",
        "on","in","at","by","of","to","as","or","if","so","an","a","but","not","no","yes","he","she","it","we","you","i"
      ]);

      function saveDraft() {
        try {
          localStorage.setItem('overExplanationDraft', draftEl.value);
        } catch (e) {}
      }

      function loadDraft() {
        try {
          const stored = localStorage.getItem('overExplanationDraft');
          if (stored && !draftEl.value.trim()) {
            draftEl.value = stored;
          }
        } catch (e) {}
      }

      function updateStats() {
        const text = draftEl.value || "";
        const words = text.trim().split(/\s+/).filter(Boolean);
        const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
        const paragraphs = text.split(/\n{2,}/).filter(p => p.trim().length > 0);
        statsLine.textContent = `${words.length} words · ${sentences.length} sentences · ${paragraphs.length} paragraphs`;
      }

      draftEl.addEventListener('input', () => {
        saveDraft();
        updateStats();
      });

      function setTheme(theme) {
        if (theme === 'light') {
          body.classList.remove('theme-dark');
          body.classList.add('theme-light');
          themeToggle.querySelector('.icon').textContent = '☀';
          themeToggle.querySelector('.label').textContent = 'White Page Mode';
        } else {
          body.classList.remove('theme-light');
          body.classList.add('theme-dark');
          themeToggle.querySelector('.icon').textContent = '☾';
          themeToggle.querySelector('.label').textContent = 'Ink After Midnight';
        }
        try {
          localStorage.setItem('overExplanationTheme', theme);
        } catch (e) {}
      }

      themeToggle.addEventListener('click', () => {
        const current = body.classList.contains('theme-light') ? 'light' : 'dark';
        setTheme(current === 'light' ? 'dark' : 'light');
      });

      function initTheme() {
        let theme = 'dark';
        try {
          const stored = localStorage.getItem('overExplanationTheme');
          if (stored === 'light' || stored === 'dark') {
            theme = stored;
          }
        } catch (e) {}
        setTheme(theme);
      }

      writingModeToggle.addEventListener('click', () => {
        const active = writingModeToggle.classList.contains('active');
        if (active) {
          writingModeToggle.classList.remove('active');
          writingModeToggle.querySelector('span:nth-child(2)').textContent = 'Writing-only';
          analysisPanel.classList.add('hidden');
        } else {
          writingModeToggle.classList.add('active');
          writingModeToggle.querySelector('span:nth-child(2)').textContent = 'Writing + Analysis';
          analysisPanel.classList.remove('hidden');
        }
      });

      toggleHighlights.addEventListener('click', () => {
        const active = toggleHighlights.classList.contains('active');
        if (active) {
          toggleHighlights.classList.remove('active');
          toggleHighlights.querySelector('span:nth-child(2)').textContent = 'Raw underlines only';
          highlightView.classList.remove('hide-highlights');
        } else {
          toggleHighlights.classList.add('active');
          toggleHighlights.querySelector('span:nth-child(2)').textContent = 'Full highlight blocks';
          highlightView.classList.add('hide-highlights');
        }
      });

      editorTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.getAttribute('data-tab');
          editorTabs.forEach(t => t.classList.toggle('active', t === tab));
          editorSurfaces.forEach(surface => {
            const surfName = surface.getAttribute('data-surface');
            surface.classList.toggle('active', surfName === target);
          });
        });
      });

      function escapeHtml(str) {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function findPhraseMatches(text) {
        const matches = [];
        const lower = text.toLowerCase();

        let idCounter = 0;

        for (const type of ['intro', 'throat', 'doubleback', 'meta']) {
          const cfg = patternConfig[type];
          cfg.phrases.forEach(phrase => {
            let idx = lower.indexOf(phrase);
            while (idx !== -1) {
              matches.push({
                id: 'm' + (idCounter++),
                type,
                label: cfg.label,
                start: idx,
                end: idx + phrase.length,
                phrase: text.slice(idx, idx + phrase.length)
              });
              idx = lower.indexOf(phrase, idx + phrase.length);
            }
          });
        }

        return matches;
      }

      function splitSentencesWithIndices(text) {
        const sentences = [];
        const regex = /[^.!?]+[.!?]+|\S+$/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
          const raw = match[0];
          const start = match.index;
          const end = start + raw.length;
          const sentenceText = raw.trim();
          if (sentenceText.length === 0) continue;
          sentences.push({
            text: sentenceText,
            start,
            end
          });
        }
        return sentences;
      }

      function textToContentWords(str) {
        return str
          .toLowerCase()
          .split(/[^a-zA-Z0-9']+/)
          .filter(w => w && w.length > 3 && !stopwords.has(w));
      }

      function jaccardSimilarity(wordsA, wordsB) {
        if (!wordsA.length || !wordsB.length) return 0;
        const setA = new Set(wordsA);
        const setB = new Set(wordsB);
        let inter = 0;
        setA.forEach(w => {
          if (setB.has(w)) inter++;
        });
        const union = new Set([...setA, ...setB]).size;
        return union === 0 ? 0 : inter / union;
      }

      function detectCircularMatches(text, sentences) {
        const matches = [];
        let idCounter = 10000;
        for (let i = 0; i < sentences.length - 1; i++) {
          const s1 = sentences[i];
          const s2 = sentences[i + 1];
          const w1 = textToContentWords(s1.text);
          const w2 = textToContentWords(s2.text);
          if (w1.length < 4 || w2.length < 4) continue;
          const score = jaccardSimilarity(w1, w2);
          if (score >= 0.6) {
            matches.push({
              id: 'm' + (idCounter++),
              type: 'circular',
              label: 'Circular explanation',
              start: s2.start,
              end: s2.end,
              phrase: text.slice(s2.start, s2.end)
            });
          }
        }
        return matches;
      }

      function detectThesisMatches(text, sentences) {
        const allWords = [];
        sentences.forEach(s => {
          allWords.push(...textToContentWords(s.text));
        });

        const freq = new Map();
        allWords.forEach(w => {
          freq.set(w, (freq.get(w) || 0) + 1);
        });

        const freqEntries = Array.from(freq.entries())
          .filter(([, count]) => count >= 3)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8);

        const thesisTerms = freqEntries.map(([w]) => w);

        const matches = [];
        let idCounter = 20000;
        const candidates = [];

        sentences.forEach((s, idx) => {
          const words = textToContentWords(s.text);
          let score = 0;
          thesisTerms.forEach(term => {
            if (words.includes(term)) score++;
          });
          if (score >= 3) {
            candidates.push({ idx, sentence: s, score });
          }
        });

        if (candidates.length > 1) {
          candidates.sort((a, b) => a.idx - b.idx);
          const primary = candidates[0];
          for (let i = 1; i < candidates.length; i++) {
            const s = candidates[i].sentence;
            matches.push({
              id: 'm' + (idCounter++),
              type: 'thesis',
              label: 'Thesis restatement',
              start: s.start,
              end: s.end,
              phrase: text.slice(s.start, s.end)
            });
          }
        }

        renderThesisTerms(thesisTerms);

        return matches;
      }

      function renderThesisTerms(terms) {
        const container = document.getElementById('thesisTerms');
        container.innerHTML = '';
        if (!terms || !terms.length) {
          const span = document.createElement('span');
          span.textContent = 'Run analysis to see dominant content words.';
          span.style.color = 'var(--text-muted)';
          container.appendChild(span);
          return;
        }
        terms.forEach(term => {
          const div = document.createElement('div');
          div.className = 'thesis-term';
          div.textContent = term;
          container.appendChild(div);
        });
      }

      function mergeMatches(matches) {
        const sorted = matches.slice().sort((a, b) => a.start - b.start || a.end - b.end);
        const result = [];
        sorted.forEach(m => {
          const last = result[result.length - 1];
          if (last && m.start >= last.start && m.end <= last.end && m.type === last.type) {
            return;
          }
          result.push(m);
        });
        return result;
      }

      function buildHighlightedHtml(text, matches) {
        if (!text.trim()) return '';
        if (!matches.length) return escapeHtml(text);

        matches = mergeMatches(matches);

        let html = '';
        let cursor = 0;

        matches.forEach(m => {
          if (m.start > cursor) {
            html += escapeHtml(text.slice(cursor, m.start));
          }
          const segment = text.slice(m.start, m.end);
          const cls = 'hl hl-' + m.type;
          html += `<span class="${cls}" data-match-id="${m.id}">${escapeHtml(segment)}</span>`;
          cursor = m.end;
        });

        if (cursor < text.length) {
          html += escapeHtml(text.slice(cursor));
        }

        return html;
      }

      function groupMatchesByType(matches) {
        const groups = {
          intro: [],
          throat: [],
          doubleback: [],
          circular: [],
          thesis: [],
          meta: []
        };
        matches.forEach(m => {
          if (groups[m.type]) {
            groups[m.type].push(m);
          }
        });
        return groups;
      }

      function renderHitList(type, matches) {
        const listEl = document.getElementById('list-' + type);
        const countEl = document.getElementById('count-' + type);
        listEl.innerHTML = '';
        countEl.textContent = matches.length;

        if (!matches.length) {
          const emptyNote = document.createElement('div');
          emptyNote.className = 'section-note';
          emptyNote.textContent = 'No obvious hits. Either you are concise, or the tool is merciful.';
          listEl.appendChild(emptyNote);
          return;
        }

        matches.forEach(m => {
          const li = document.createElement('li');
          li.className = 'hit-item';
          li.dataset.matchId = m.id;

          const label = document.createElement('div');
          label.className = 'hit-label';
          label.textContent = m.label;

          const snippet = document.createElement('div');
          snippet.className = 'hit-snippet';
          const raw = m.phrase || '';
          const trimmed = raw.replace(/\s+/g, ' ').trim();
          const shortened = trimmed.length > 80 ? trimmed.slice(0, 77) + '…' : trimmed;
          const codeEl = document.createElement('code');
          codeEl.textContent = shortened || '[…]';
          snippet.appendChild(codeEl);

          li.appendChild(label);
          li.appendChild(snippet);
          listEl.appendChild(li);
        });
      }

      function wireHitListClicks() {
        const items = document.querySelectorAll('.hit-item');
        items.forEach(item => {
          item.addEventListener('click', () => {
            const id = item.dataset.matchId;
            const span = highlightView.querySelector(`[data-match-id="${id}"]`);
            if (span) {
              span.scrollIntoView({ behavior: 'smooth', block: 'center' });
              span.classList.remove('hl-pulse');
              void span.offsetWidth;
              span.classList.add('hl-pulse');
              const debugTab = document.querySelector('.editor-tab[data-tab="highlighted"]');
              if (!debugTab.classList.contains('active')) {
                debugTab.click();
              }
            }
          });
        });
      }

      function runAnalysis() {
        const text = draftEl.value || '';
        updateStats();

        if (!text.trim()) {
          highlightView.innerHTML = 'Nothing to analyse yet. Paste or type some text first.';
          highlightView.classList.add('empty');
          ['intro','throat','doubleback','circular','thesis','meta'].forEach(type => {
            renderHitList(type, []);
          });
          renderThesisTerms([]);
          currentMatches = [];
          return;
        }

        const phraseMatches = findPhraseMatches(text);
        const sentences = splitSentencesWithIndices(text);
        const circularMatches = detectCircularMatches(text, sentences);
        const thesisMatches = detectThesisMatches(text, sentences);

        const all = [...phraseMatches, ...circularMatches, ...thesisMatches];
        currentMatches = all;

        const html = buildHighlightedHtml(text, all);
        highlightView.innerHTML = html;
        highlightView.classList.remove('empty');

        const grouped = groupMatchesByType(all);
        renderHitList('intro', grouped.intro);
        renderHitList('throat', grouped.throat);
        renderHitList('doubleback', grouped.doubleback);
        renderHitList('circular', grouped.circular);
        renderHitList('thesis', grouped.thesis);
        renderHitList('meta', grouped.meta);

        wireHitListClicks();
      }

      function downloadFile(filename, content, mime) {
        const blob = new Blob([content], { type: mime || 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      exportMdBtn.addEventListener('click', () => {
        const text = draftEl.value || '';
        downloadFile('draft.md', text, 'text/markdown;charset=utf-8');
      });

      exportHtmlBtn.addEventListener('click', () => {
        const text = draftEl.value || '';
        const annotated = buildHighlightedHtml(text, currentMatches || []);
        const doc = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Annotated Draft · Over-Explanation Detector</title>
<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #111119;
  color: #f5f5f7;
  padding: 20px;
}
pre {
  white-space: pre-wrap;
  font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 13px;
  line-height: 1.6;
}
.hl-intro { background: rgba(255,255,255,0.03); border-bottom: 1px dotted rgba(180,180,200,0.9); }
.hl-throat { background: rgba(255,107,129,0.13); border-bottom: 1px dotted #ff6b81; }
.hl-doubleback { background: rgba(255,211,107,0.16); border-bottom: 1px dotted #ffd36b; }
.hl-circular { background: rgba(127,208,255,0.14); border-bottom: 1px dotted #7fd0ff; }
.hl-thesis { background: rgba(245,199,92,0.19); border-bottom: 1px dotted #f5c75c; }
.hl-meta { background: rgba(181,137,0,0.16); border-bottom: 1px dotted #b58900; }
</style>
</head>
<body>
<h1>Annotated Draft</h1>
<p>Generated by Over-Explanation Detector (local HTML tool).</p>
<pre>${annotated}</pre>
</body>
</html>`;
        downloadFile('annotated-draft.html', doc, 'text/html;charset=utf-8');
      });

      runAnalysisBtn.addEventListener('click', runAnalysis);

      draftEl.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'enter') {
          e.preventDefault();
          runAnalysis();
        }
      });

      loadDraft();
      initTheme();
      updateStats();
    })();
  </script>
</body>
</html>
